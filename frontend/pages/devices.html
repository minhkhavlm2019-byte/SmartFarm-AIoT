<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Thi·∫øt b·ªã</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li class="active" onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
                </ul>
        </nav>

        <main class="content">
            <header>
                <h2>Danh s√°ch Thi·∫øt b·ªã IoT</h2>
            </header>

            <section class="tab-content" style="display: block;">
                <button onclick="loadDevices()" style="margin-bottom: 15px; padding: 10px;">
                    <i class="fas fa-sync"></i> L√†m m·ªõi
                </button>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Thi·∫øt b·ªã</th>
                            <th>T√™n</th>
                            <th>Khu v·ª±c (Zone)</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="device-table-body">
                        <tr><td colspan="5">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
        // H√†m ch·∫°y ngay khi trang t·∫£i xong
        document.addEventListener("DOMContentLoaded", () => {
            loadDevices();
        });

        // H√†m l·∫•y danh s√°ch thi·∫øt b·ªã th·∫≠t t·ª´ Server
        async function loadDevices() {
            const tbody = document.getElementById('device-table-body');
            tbody.innerHTML = '<tr><td colspan="5">ƒêang c·∫≠p nh·∫≠t...</td></tr>';

            // G·ªçi API: GET /devices
            const devices = await fetchAPI('/devices/');

            if (devices) {
                tbody.innerHTML = ''; // X√≥a d√≤ng "ƒêang t·∫£i..."
                
                devices.forEach(dev => {
                    // T·∫°o m√†u cho tr·∫°ng th√°i
                    const statusClass = dev.status === 'ONLINE' ? 'online' : 'offline';
                    
                    const row = `
                        <tr>
                            <td>${dev.device_id}</td>
                            <td>${dev.name}</td>
                            <td>${dev.zone_id ? 'Zone ' + dev.zone_id : 'Ch∆∞a g√°n'}</td>
                            <td><span class="tag ${statusClass}">${dev.status}</span></td>
                            <td>
                                <button onclick="controlDevice('${dev.device_id}', 'PUMP_ON')" class="btn-sm btn-on">B·∫≠t B∆°m</button>
                                <button onclick="controlDevice('${dev.device_id}', 'PUMP_OFF')" class="btn-sm btn-off">T·∫Øt B∆°m</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="color:red">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
            }
        }

        // H√†m ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã
        async function controlDevice(deviceId, action) {
            if(confirm(`G·ª≠i l·ªánh ${action} t·ªõi ${deviceId}?`)) {
                // G·ªçi API: POST /devices/{id}/control
                const result = await fetchAPI(`/devices/${deviceId}/control?action=${action}`, 'POST');
                if(result) {
                    alert("L·ªánh ƒë√£ g·ª≠i th√†nh c√¥ng!");
                }
            }
        }
    </script>
</body>
</html>