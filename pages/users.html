<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng - Smart Farm</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS ri√™ng cho trang Users */
        .btn-add-user {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .btn-add-user:hover { background: #219150; }
        .role-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: white; }
        .role-admin { background: #e74c3c; }
        .role-farmer { background: #f39c12; }
    </style>
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
                <li class="active" onclick="location.href='users.html'"><i class="fas fa-users"></i> Ng∆∞·ªùi d√πng</li>
                <li onclick="logout()" class="logout"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</li>
            </ul>
        </nav>

        <main class="content">
            <header>
                <h2>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
                <div class="user-info">Xin ch√†o, <span id="display-name">Admin</span></div>
            </header>

            <section class="tab-content" style="display: block;">
                <button onclick="document.getElementById('addUserModal').style.display='block'" class="btn-add-user">
                    <i class="fas fa-user-plus"></i> Th√™m Ng∆∞·ªùi D√πng
                </button>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n ƒëƒÉng nh·∫≠p</th>
                            <th>H·ªç v√† T√™n</th>
                            <th>Email</th>
                            <th>Quy·ªÅn h·∫°n</th>
                            <th>Ng√†y t·∫°o</th>
                            </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <tr><td colspan="7">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <div id="addUserModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000; width: 350px;">
        <h3 style="margin-top:0; color:#27ae60;">T·∫°o T√†i Kho·∫£n M·ªõi</h3>
        
        <label>T√™n ƒëƒÉng nh·∫≠p:</label>
        <input type="text" id="new_username" style="width:100%; padding:8px; margin:5px 0 10px;">
        
        <label>M·∫≠t kh·∫©u:</label>
        <input type="password" id="new_password" style="width:100%; padding:8px; margin:5px 0 10px;">
        
        <label>H·ªç v√† T√™n:</label>
        <input type="text" id="new_fullname" style="width:100%; padding:8px; margin:5px 0 10px;">

        <label>Quy·ªÅn h·∫°n:</label>
        <select id="new_role" style="width:100%; padding:8px; margin:5px 0 10px;">
            <option value="farmer">N√¥ng d√¢n (Farmer)</option>
            <option value="admin">Qu·∫£n tr·ªã vi√™n (Admin)</option>
        </select>
        
        <div style="text-align: right; margin-top: 15px;">
            <button onclick="document.getElementById('addUserModal').style.display='none'" class="btn-off">H·ªßy</button>
            <button onclick="submitNewUser()" class="btn-on">T·∫°o M·ªõi</button>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadUsers();
        });

        async function loadUsers() {
            const tbody = document.getElementById('user-table-body');
            
            // --- 1. KI·ªÇM TRA QUY·ªÄN (QUAN TR·ªåNG) ---
            // L·∫•y role t·ª´ LocalStorage (VD: "ADMIN")
            const rawRole = localStorage.getItem('user_role');
            
            // Chuy·ªÉn h·∫øt v·ªÅ ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh (VD: "ADMIN" -> "admin")
            const role = (rawRole || "").toLowerCase(); 

            // So s√°nh: N·∫øu kh√¥ng ph·∫£i 'admin' th√¨ ch·∫∑n
            if (role !== 'admin') {
                tbody.innerHTML = '<tr><td colspan="7" style="color:red; text-align:center; padding: 20px;">üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y (Ch·ªâ d√†nh cho Admin).</td></tr>';
                
                // ·∫®n n√∫t th√™m ng∆∞·ªùi d√πng
                const btnAdd = document.querySelector('.btn-add-user');
                if (btnAdd) btnAdd.style.display = 'none'; 
                return;
            }

            // --- 2. T·∫¢I DANH S√ÅCH ---
            try {
                const users = await fetchAPI('/users/');

                if (users && users.length > 0) {
                    tbody.innerHTML = '';
                    users.forEach(u => {
                        // Chu·∫©n h√≥a role c·ªßa t·ª´ng user trong danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã m√†u
                        // u.role t·ª´ DB tr·∫£ v·ªÅ l√† "ADMIN" ho·∫∑c "FARMER"
                        const userRole = (u.role || "").toLowerCase(); 
                        
                        // N·∫øu l√† admin th√¨ class m√†u ƒë·ªè, farmer m√†u v√†ng
                        const roleClass = userRole === 'admin' ? 'role-admin' : 'role-farmer';
                        
                        // Format ng√†y th√°ng
                        const dateStr = u.created_at ? new Date(u.created_at).toLocaleDateString('vi-VN') : '---';
                        
                        const row = `
                            <tr>
                                <td>${u.user_id}</td>
                                <td><strong>${u.username}</strong></td>
                                <td>${u.full_name || '---'}</td>
                                <td>${u.email || '---'}</td>
                                <td><span class="role-badge ${roleClass}">${userRole.toUpperCase()}</span></td>
                                <td>${dateStr}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>';
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</td></tr>`;
            }
        }

        async function submitNewUser() {
            const username = document.getElementById('new_username').value;
            const password = document.getElementById('new_password').value;
            const fullname = document.getElementById('new_fullname').value;
            
            // L·∫•y value t·ª´ select (VD: "ADMIN" ho·∫∑c "FARMER")
            const role = document.getElementById('new_role').value;

            if(!username || !password) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");

            const payload = {
                username: username,
                password: password,
                full_name: fullname,
                role: role // G·ª≠i ƒë√∫ng chu·ªói "ADMIN" ho·∫∑c "FARMER" l√™n Server
            };

            const res = await fetchAPI('/users/register', 'POST', payload);
            
            if(res) {
                alert("T·∫°o t√†i kho·∫£n th√†nh c√¥ng!");
                document.getElementById('addUserModal').style.display = 'none';
                loadUsers();
            }
        }
    </script>
</body>
</html>
<!-- <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ng∆∞·ªùi d√πng - Smart Farm</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
                <li onclick="location.href='users.html'"><i class="fas fa-users"></i> Ng∆∞·ªùi d√πng</li>
                <li onclick="logout()" class="logout"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</li>
            </ul>
        </nav>

        <main class="content">
            <header>
                <h2>Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
                <div class="user-info">Xin ch√†o, <span id="display-name">Admin</span></div>
            </header>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>T√™n ƒëƒÉng nh·∫≠p</th>
                        <th>H·ªç v√† T√™n</th>
                        <th>Quy·ªÅn h·∫°n</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>admin</td>
                        <td>Super Admin</td>
                        <td><span class="tag online">Admin</span></td>
                        <td>01/01/2026</td>
                        <td><button class="btn-sm btn-off" disabled>Kh√≥a</button></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>farmer_a</td>
                        <td>Nguy·ªÖn VƒÉn A</td>
                        <td><span class="tag" style="background:#f39c12">Farmer</span></td>
                        <td>15/02/2026</td>
                        <td><button class="btn-sm btn-off">Kh√≥a</button></td>
                    </tr>
                </tbody>
            </table>
        </main>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html> -->