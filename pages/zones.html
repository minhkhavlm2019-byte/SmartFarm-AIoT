<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Khu V·ª±c (Zones)</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .zone-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .zone-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; border-left: 5px solid #27ae60; }
        .zone-card h3 { color: #2c3e50; margin-bottom: 5px; }
        .zone-card .meta { font-size: 13px; color: #7f8c8d; margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .device-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        /* Modal Tabs */
        .modal-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #7f8c8d; }
        .tab-btn.active { color: #27ae60; border-bottom: 2px solid #27ae60; }
    </style>
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li class="active" onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
            </ul>
        </nav>

        <main class="content">
            <header><h2>Khu V·ª±c Canh T√°c</h2></header>
            <section class="tab-content" style="display: block;">
                <button onclick="document.getElementById('addZoneModal').style.display='block'" class="admin-only" class="btn-on">
                    <i class="fas fa-plus"></i> T·∫°o Khu V·ª±c M·ªõi
                </button>
                <div id="zone-list" class="zone-grid"><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></div>
            </section>
        </main>
    </div>

    <div id="addZoneModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000; width: 300px;">
        <h3>T·∫°o Khu V·ª±c M·ªõi</h3>
        <input type="text" id="new_zone_name" placeholder="T√™n Khu V·ª±c" style="display:block; margin:10px 0; width: 100%; padding: 8px;">
        <input type="text" id="new_zone_desc" placeholder="M√¥ t·∫£" style="display:block; margin:10px 0; width: 100%; padding: 8px;">
        <input type="text" id="new_zone_crop" value="Rau C·∫£i" style="display:block; margin:10px 0; width: 100%; padding: 8px;">
        <div style="text-align: right;">
            <button onclick="document.getElementById('addZoneModal').style.display='none'" class="btn-off">H·ªßy</button>
            <button onclick="submitNewZone()" class="btn-on">L∆∞u</button>
        </div>
    </div>

    <div id="editZoneModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 1000; width: 400px;">
        <h3 id="edit_modal_title">Qu·∫£n l√Ω Zone</h3>
        
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="switchTab('info')">Th√¥ng tin</button>
            <button class="tab-btn" onclick="switchTab('devices')">Thi·∫øt b·ªã</button>
        </div>

        <div id="tab-info">
            <input type="hidden" id="edit_zone_id">
            <label>T√™n Zone:</label>
            <input type="text" id="edit_zone_name" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <label>Lo·∫°i c√¢y:</label>
            <input type="text" id="edit_zone_crop" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <label>M√¥ t·∫£:</label>
            <input type="text" id="edit_zone_desc" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <div style="text-align: right; margin-top: 10px;">
                <button onclick="closeEditModal()" class="btn-off">ƒê√≥ng</button>
                <button onclick="submitUpdateZone()" class="btn-on">C·∫≠p nh·∫≠t</button>
            </div>
        </div>

        <div id="tab-devices" style="display:none;">
            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc;">
                <label><b>Th√™m thi·∫øt b·ªã v√†o Zone n√†y:</b></label>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <select id="select_free_device" style="flex: 1; padding: 5px;">
                        <option>ƒêang t·∫£i...</option>
                    </select>
                    <button onclick="addDeviceToZone()" class="btn-sm btn-on"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            
            <label><b>Thi·∫øt b·ªã ƒëang c√≥:</b></label>
            <div id="zone_device_list" style="max-height: 150px; overflow-y: auto; margin-top: 5px;">
                </div>
            <div style="text-align: right; margin-top: 15px;">
                <button onclick="closeEditModal()" class="btn-off">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", loadZones);

        // --- 1. T·∫¢I DANH S√ÅCH ZONE ---
        async function loadZones() {
            const container = document.getElementById('zone-list');
            const zones = await fetchAPI('/zones/');
            
            // L·∫•y th√™m danh s√°ch thi·∫øt b·ªã ƒë·ªÉ ƒë·∫øm s·ªë l∆∞·ª£ng (Option)
            const devices = await fetchAPI('/devices/'); 

            if (zones && zones.length > 0) {
                container.innerHTML = '';
                zones.forEach(zone => {
                    // ƒê·∫øm s·ªë thi·∫øt b·ªã trong zone n√†y
                    const count = devices ? devices.filter(d => d.zone_id === zone.zone_id).length : 0;
                    
                    const card = `
                        <div class="zone-card">
                            <h3><i class="fas fa-seedling"></i> ${zone.name}</h3>
                            <div class="meta">...</div>
                            <p>${zone.description || 'Ch∆∞a c√≥ m√¥ t·∫£'}</p>
                            
                            <div class="btn-group">
                                <button onclick="openEditModal(${zone.zone_id}, ...)" class="btn-sm" style="...">
                                    <i class="fas fa-edit"></i> Qu·∫£n l√Ω
                                </button>
                                <button onclick="deleteZone(${zone.zone_id})" class="btn-sm admin-only" style="background:#e74c3c; color:white; border:none; width:40px; cursor:pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
            } else {
                container.innerHTML = '<p>Ch∆∞a c√≥ khu v·ª±c n√†o.</p>';
            }
        }

        // --- 2. X·ª¨ L√ù MODAL EDIT ---
        let currentZoneId = null;

        function openEditModal(id, name, crop, desc) {
            currentZoneId = id;
            document.getElementById('edit_zone_id').value = id;
            document.getElementById('edit_zone_name').value = name;
            document.getElementById('edit_zone_crop').value = crop;
            document.getElementById('edit_zone_desc').value = (desc && desc !== 'null') ? desc : '';
            document.getElementById('edit_modal_title').innerText = "Qu·∫£n l√Ω: " + name;
            
            // M·ªü modal v√† reset v·ªÅ tab info
            document.getElementById('editZoneModal').style.display = 'block';
            switchTab('info');
            
            // Load danh s√°ch thi·∫øt b·ªã
            loadZoneDevices(id);
        }

        function closeEditModal() {
            document.getElementById('editZoneModal').style.display = 'none';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#tab-info, #tab-devices').forEach(d => d.style.display = 'none');
            
            if(tabName === 'info') {
                document.getElementById('tab-info').style.display = 'block';
                document.querySelector('button[onclick="switchTab(\'info\')"]').classList.add('active');
            } else {
                document.getElementById('tab-devices').style.display = 'block';
                document.querySelector('button[onclick="switchTab(\'devices\')"]').classList.add('active');
            }
        }

        // --- 3. C·∫¨P NH·∫¨T TH√îNG TIN ZONE ---
        async function submitUpdateZone() {
            const name = document.getElementById('edit_zone_name').value;
            const crop = document.getElementById('edit_zone_crop').value;
            const desc = document.getElementById('edit_zone_desc').value;

            const payload = { name: name, crop_type: crop, description: desc };
            const res = await fetchAPI(`/zones/${currentZoneId}`, 'PUT', payload);
            
            if(res) {
                alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                closeEditModal();
                loadZones();
            }
        }

        // --- 4. QU·∫¢N L√ù THI·∫æT B·ªä TRONG ZONE ---
        async function loadZoneDevices(zoneId) {
            const allDevices = await fetchAPI('/devices/');
            const zoneListDiv = document.getElementById('zone_device_list');
            const freeSelect = document.getElementById('select_free_device');
            
            zoneListDiv.innerHTML = '';
            freeSelect.innerHTML = '<option value="">-- Ch·ªçn thi·∫øt b·ªã ƒë·ªÉ th√™m --</option>';
            
            if(allDevices) {
                allDevices.forEach(dev => {
                    // N·∫øu thi·∫øt b·ªã thu·ªôc zone n√†y -> Hi·ªÉn th·ªã trong danh s√°ch
                    if (dev.zone_id === zoneId) {
                        const item = `
                            <div class="device-list-item">
                                <span><b>${dev.device_id}</b> (${dev.name})</span>
                                <button onclick="removeDeviceFromZone('${dev.device_id}')" style="color:red; background:none; border:none; cursor:pointer;">
                                    <i class="fas fa-times-circle"></i> B·ªè
                                </button>
                            </div>
                        `;
                        zoneListDiv.innerHTML += item;
                    } 
                    // N·∫øu thi·∫øt b·ªã ch∆∞a c√≥ zone (zone_id null) -> Th√™m v√†o dropdown
                    else if (!dev.zone_id) {
                        const opt = document.createElement('option');
                        opt.value = dev.device_id;
                        opt.innerText = `${dev.device_id} - ${dev.name}`;
                        freeSelect.appendChild(opt);
                    }
                });
            }
            
            if(zoneListDiv.innerHTML === '') zoneListDiv.innerHTML = '<p style="color:#999; font-size:13px;">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o.</p>';
        }

        // Th√™m thi·∫øt b·ªã v√†o Zone
        async function addDeviceToZone() {
            const deviceId = document.getElementById('select_free_device').value;
            if(!deviceId) return alert("Vui l√≤ng ch·ªçn thi·∫øt b·ªã!");
            
            // G·ªçi API c·∫≠p nh·∫≠t thi·∫øt b·ªã: G√°n zone_id = currentZoneId
            await fetchAPI(`/devices/${deviceId}`, 'PUT', { zone_id: currentZoneId });
            loadZoneDevices(currentZoneId); // Load l·∫°i danh s√°ch trong modal
            loadZones(); // Load l·∫°i danh s√°ch ngo√†i dashboard ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        }

        // X√≥a thi·∫øt b·ªã kh·ªèi Zone (G√°n zone_id = null)
        async function removeDeviceFromZone(deviceId) {
            if(confirm("G·ª° thi·∫øt b·ªã n√†y kh·ªèi khu v·ª±c?")) {
                await fetchAPI(`/devices/${deviceId}`, 'PUT', { zone_id: null });
                loadZoneDevices(currentZoneId);
                loadZones();
            }
        }

        // --- 5. T·∫†O ZONE M·ªöI ---
        async function submitNewZone() {
            const name = document.getElementById('new_zone_name').value;
            const desc = document.getElementById('new_zone_desc').value;
            const crop = document.getElementById('new_zone_crop').value;
            if(!name) return alert("Nh·∫≠p t√™n Zone!");
            
            await fetchAPI('/zones/', 'POST', { name: name, description: desc, crop_type: crop });
            document.getElementById('addZoneModal').style.display = 'none';
            loadZones();
        }

        async function deleteZone(id) {
            if(confirm("X√≥a khu v·ª±c n√†y? C√°c thi·∫øt b·ªã s·∫Ω b·ªã g·ª° b·ªè.")) {
                await fetchAPI(`/zones/${id}`, 'DELETE');
                loadZones();
            }
        }
    </script>
</body>
</html>
<!-- <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Zone - Smart Farm</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
                <li onclick="location.href='users.html'"><i class="fas fa-users"></i> Ng∆∞·ªùi d√πng</li>
                <li onclick="logout()" class="logout"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</li>
            </ul>
        </nav>

        <main class="content">
            <header>
                <h2>Qu·∫£n l√Ω Khu v·ª±c (Zones)</h2>
                <div class="user-info">Xin ch√†o, <span id="display-name">Admin</span></div>
            </header>

            <div class="toolbar">
                <button class="btn-login" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-plus"></i> Th√™m Khu v·ª±c m·ªõi
                </button>
            </div>

            <div class="zone-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                
                <div class="card zone-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>üåø V∆∞·ªùn X√† L√°ch</h3>
                        <span class="tag online">Ho·∫°t ƒë·ªông</span>
                    </div>
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
                    <p><strong>Lo·∫°i c√¢y:</strong> Rau ƒÉn l√°</p>
                    <p><strong>S·ªë l∆∞·ª£ng thi·∫øt b·ªã:</strong> 2</p>
                    <div style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <p><i class="fas fa-thermometer-half"></i> C·∫£nh b√°o nhi·ªát: <strong>> 35¬∞C</strong></p>
                        <p><i class="fas fa-tint"></i> T∆∞·ªõi khi ƒë·∫•t: <strong>< 40%</strong></p>
                    </div>
                    <button class="btn-sm btn-on" style="width: 100%">C·∫•u h√¨nh AI</button>
                </div>

                <div class="card zone-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>üçÖ V∆∞·ªùn C√† Chua</h3>
                        <span class="tag offline">B·∫£o tr√¨</span>
                    </div>
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
                    <p><strong>Lo·∫°i c√¢y:</strong> C√¢y ƒÉn qu·∫£</p>
                    <p><strong>S·ªë l∆∞·ª£ng thi·∫øt b·ªã:</strong> 1</p>
                    <div style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <p><i class="fas fa-thermometer-half"></i> C·∫£nh b√°o nhi·ªát: <strong>> 38¬∞C</strong></p>
                        <p><i class="fas fa-tint"></i> T∆∞·ªõi khi ƒë·∫•t: <strong>< 30%</strong></p>
                    </div>
                    <button class="btn-sm btn-on" style="width: 100%">C·∫•u h√¨nh AI</button>
                </div>

            </div>
        </main>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html> -->