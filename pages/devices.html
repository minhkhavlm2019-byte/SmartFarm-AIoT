<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Thi·∫øt b·ªã</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li class="active" onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
            </ul>
        </nav>

        <main class="content">
            <header>
                <h2>Danh s√°ch Thi·∫øt b·ªã IoT</h2>
            </header>

            <section class="tab-content" style="display: block;">
                <button onclick="showAddDeviceForm()" class="admin-only" style="margin-bottom: 15px; padding: 10px; background: #27ae60; color: white; border: none; cursor: pointer;">
                    <i class="fas fa-plus"></i> Th√™m Thi·∫øt B·ªã
                </button>
                <button onclick="loadDevices()" style="margin-bottom: 15px; padding: 10px; cursor: pointer;">
                    <i class="fas fa-sync"></i> L√†m m·ªõi
                </button>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Thi·∫øt b·ªã</th>
                            <th>T√™n</th>
                            <th>Khu v·ª±c (Zone)</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="device-table-body">
                        <tr><td colspan="5">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <div id="addDeviceModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border:1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000; width: 300px; border-radius: 8px;">
        <h3 style="margin-top: 0;">Th√™m Thi·∫øt B·ªã M·ªõi</h3>
        
        <label>ID Thi·∫øt b·ªã (MAC):</label>
        <input type="text" id="new_device_id" placeholder="VD: ESP32_01" style="display:block; margin:5px 0 15px; width: 100%; padding: 8px; box-sizing: border-box;">
        
        <label>T√™n hi·ªÉn th·ªã:</label>
        <input type="text" id="new_device_name" placeholder="VD: V∆∞·ªùn Lan" style="display:block; margin:5px 0 15px; width: 100%; padding: 8px; box-sizing: border-box;">
        
        <div style="text-align: right;">
            <button onclick="document.getElementById('addDeviceModal').style.display='none'" class="btn-sm btn-off">H·ªßy</button>
            <button onclick="submitNewDevice()" class="btn-sm btn-on">L∆∞u</button>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
        // --- 1. KH·ªûI T·∫†O ---
        document.addEventListener("DOMContentLoaded", () => {
            loadDevices();
        });

        // --- 2. H√ÄM T·∫¢I DANH S√ÅCH ---
        async function loadDevices() {
            const tbody = document.getElementById('device-table-body');
            tbody.innerHTML = '<tr><td colspan="5">ƒêang c·∫≠p nh·∫≠t...</td></tr>';

            // G·ªçi API: GET /devices/
            const devices = await fetchAPI('/devices/');

            if (devices) {
                tbody.innerHTML = ''; 
                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o.</td></tr>';
                    return;
                }

                devices.forEach(dev => {
                    const statusClass = dev.status === 'ONLINE' ? 'online' : 'offline';
                    
                    const row = `
                        <tr>
                            <td>${dev.device_id}</td>
                            <td>${dev.name}</td>
                            <td>${dev.zone_id ? 'Zone ' + dev.zone_id : 'Ch∆∞a g√°n'}</td>
                            <td><span class="tag ${statusClass}">${dev.status}</span></td>
                            <td>
                                <button onclick="controlDevice('${dev.device_id}', 'PUMP_ON')" class="btn-sm btn-on">B·∫≠t B∆°m</button>
                                <button onclick="controlDevice('${dev.device_id}', 'PUMP_OFF')" class="btn-sm btn-off">T·∫Øt B∆°m</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="color:red">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
            }
        }

        // --- 3. H√ÄM ƒêI·ªÄU KHI·ªÇN ---
        async function controlDevice(deviceId, action) {
            // Kh√¥ng c·∫ßn confirm cho nhanh, ho·∫∑c gi·ªØ l·∫°i n·∫øu mu·ªën an to√†n
            console.log(`Sending ${action} to ${deviceId}`);
            
            // G·ªçi API: POST /devices/{id}/control
            const result = await fetchAPI(`/devices/${deviceId}/control?action=${action}`, 'POST');
            
            if(result) {
                alert(`ƒê√£ g·ª≠i l·ªánh: ${action}`);
            }
        }

        // --- 4. H√ÄM X·ª¨ L√ù FORM TH√äM M·ªöI ---
        function showAddDeviceForm() {
            document.getElementById('addDeviceModal').style.display = 'block';
        }

        async function submitNewDevice() {
            const id = document.getElementById('new_device_id').value.trim();
            const name = document.getElementById('new_device_name').value.trim();

            if(!id) return alert("Vui l√≤ng nh·∫≠p Device ID!");

            const payload = {
                device_id: id,
                name: name || `Device ${id}`, // N·∫øu kh√¥ng nh·∫≠p t√™n th√¨ l·∫•y ID l√†m t√™n
                zone_id: null
            };

            // G·ªçi API t·∫°o m·ªõi
            const response = await fetchAPI('/devices/', 'POST', payload);
            
            if(response) {
                alert("Th√™m th√†nh c√¥ng!");
                document.getElementById('addDeviceModal').style.display = 'none';
                
                // Reset form
                document.getElementById('new_device_id').value = '';
                document.getElementById('new_device_name').value = '';

                // T·∫£i l·∫°i danh s√°ch
                loadDevices(); 
            }
        }
    </script>
</body>
</html>
<!-- <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Thi·∫øt b·ªã</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <div class="logo"><h3>üå± Smart Farm</h3></div>
            <ul>
                <li onclick="location.href='../dashboard.html'"><i class="fas fa-home"></i> Trang Ch·ªß</li>
                <li onclick="location.href='zones.html'"><i class="fas fa-layer-group"></i> Qu·∫£n l√Ω Zone</li>
                <li class="active" onclick="location.href='devices.html'"><i class="fas fa-microchip"></i> Thi·∫øt b·ªã IoT</li>
                </ul>
        </nav>

        <main class="content">
            <header>
                <h2>Danh s√°ch Thi·∫øt b·ªã IoT</h2>
            </header>

            <section class="tab-content" style="display: block;">
                <button onclick="showAddDeviceForm()" style="margin-bottom: 15px; padding: 10px;">
                    <i class="fas fa-plus"></i> Th√™m Thi·∫øt B·ªã
                </button>
                <button onclick="loadDevices()" style="margin-bottom: 15px; padding: 10px;">
                    <i class="fas fa-sync"></i> L√†m m·ªõi
                </button>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Thi·∫øt b·ªã</th>
                            <th>T√™n</th>
                            <th>Khu v·ª±c (Zone)</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="device-table-body">
                        <tr><td colspan="5">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>
    <div id="addDeviceModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border:1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000;">
    <h3>Th√™m Thi·∫øt B·ªã M·ªõi</h3>
    <input type="text" id="new_device_id" placeholder="Device ID (VD: ESP32_03)" style="display:block; margin:10px 0; width: 100%; padding: 8px;">
    <input type="text" id="new_device_name" placeholder="T√™n hi·ªÉn th·ªã (VD: V∆∞·ªùn Lan)" style="display:block; margin:10px 0; width: 100%; padding: 8px;">
    <button onclick="submitNewDevice()" class="btn-sm btn-on">L∆∞u</button>
    <button onclick="document.getElementById('addDeviceModal').style.display='none'" class="btn-sm btn-off">H·ªßy</button>
</div>

    <script src="../assets/js/api.js"></script>
    <script>
        // H√†m ch·∫°y ngay khi trang t·∫£i xong
        document.addEventListener("DOMContentLoaded", () => {
            loadDevices();
        });

        // H√†m l·∫•y danh s√°ch thi·∫øt b·ªã th·∫≠t t·ª´ Server
        async function loadDevices() {
            const tbody = document.getElementById('device-table-body');
            tbody.innerHTML = '<tr><td colspan="5">ƒêang c·∫≠p nh·∫≠t...</td></tr>';

            // G·ªçi API: GET /devices
            const devices = await fetchAPI('/devices/');

            if (devices) {
                tbody.innerHTML = ''; // X√≥a d√≤ng "ƒêang t·∫£i..."
                
                devices.forEach(dev => {
                    // T·∫°o m√†u cho tr·∫°ng th√°i
                    const statusClass = dev.status === 'ONLINE' ? 'online' : 'offline';
                    
                    const row = `
                        <tr>
                            <td>${dev.device_id}</td>
                            <td>${dev.name}</td>
                            <td>${dev.zone_id ? 'Zone ' + dev.zone_id : 'Ch∆∞a g√°n'}</td>
                            <td><span class="tag ${statusClass}">${dev.status}</span></td>
                            <td>
                                <button onclick="controlDevice('${dev.device_id}', 'PUMP_ON')" class="btn-sm btn-on">B·∫≠t B∆°m</button>
                                <button onclick="controlDevice('${dev.device_id}', 'PUMP_OFF')" class="btn-sm btn-off">T·∫Øt B∆°m</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="color:red">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
            }
        }

        // H√†m ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã
        async function controlDevice(deviceId, action) {
            if(confirm(`G·ª≠i l·ªánh ${action} t·ªõi ${deviceId}?`)) {
                // G·ªçi API: POST /devices/{id}/control
                const result = await fetchAPI(`/devices/${deviceId}/control?action=${action}`, 'POST');
                if(result) {
                    alert("L·ªánh ƒë√£ g·ª≠i th√†nh c√¥ng!");
                }
            }
        }
    </script>
    <script>
    // --- 1. H√†m t·∫£i danh s√°ch thi·∫øt b·ªã (ƒê√£ c√≥ s·∫µn) ---
    document.addEventListener("DOMContentLoaded", () => {
        loadDevices();
    });

    async function loadDevices() {
        const tbody = document.getElementById('device-table-body');
        tbody.innerHTML = '<tr><td colspan="5">ƒêang c·∫≠p nh·∫≠t...</td></tr>';

        // G·ªçi API qua h√†m wrapper
        const devices = await fetchAPI('/devices/');

        if (devices) {
            tbody.innerHTML = ''; 
            devices.forEach(dev => {
                const statusClass = dev.status === 'ONLINE' ? 'online' : 'offline';
                // (Gi·ªØ nguy√™n logic render b·∫£ng c·ªßa b·∫°n ·ªü ƒë√¢y...)
                const row = `
                    <tr>
                        <td>${dev.device_id}</td>
                        <td>${dev.name}</td>
                        <td>${dev.zone_id ? 'Zone ' + dev.zone_id : 'Ch∆∞a g√°n'}</td>
                        <td><span class="tag ${statusClass}">${dev.status}</span></td>
                        <td>
                            <button onclick="controlDevice('${dev.device_id}', 'PUMP_ON')" class="btn-sm btn-on">B·∫≠t</button>
                            <button onclick="controlDevice('${dev.device_id}', 'PUMP_OFF')" class="btn-sm btn-off">T·∫Øt</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="color:red">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
        }
    }

    // --- 2. H√†m ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã (ƒê√£ c√≥ s·∫µn) ---
    async function controlDevice(deviceId, action) {
        // (Gi·ªØ nguy√™n code c≈©...)
        if(confirm(`G·ª≠i l·ªánh ${action} t·ªõi ${deviceId}?`)) {
            await fetchAPI(`/devices/${deviceId}/control?action=${action}`, 'POST');
            alert("ƒê√£ g·ª≠i l·ªánh!");
        }
    }

    // --- 3. LOGIC TH√äM M·ªöI (V·ª´a chuy·ªÉn t·ª´ api.js sang) ---
    function showAddDeviceForm() {
        // ƒê·∫£m b·∫£o b·∫°n ƒë√£ th√™m ƒëo·∫°n HTML Modal v√†o body tr∆∞·ªõc ƒë√≥
        const modal = document.getElementById('addDeviceModal');
        if(modal) modal.style.display = 'block';
    }

    async function submitNewDevice() {
        const id = document.getElementById('new_device_id').value;
        const name = document.getElementById('new_device_name').value;

        if(!id) return alert("Vui l√≤ng nh·∫≠p Device ID!");

        const payload = {
            device_id: id,
            name: name,
            zone_id: null
        };

        // G·ªçi API t·∫°o m·ªõi
        const response = await fetchAPI('/devices/', 'POST', payload);
        
        if(response) {
            alert("Th√™m th√†nh c√¥ng!");
            document.getElementById('addDeviceModal').style.display = 'none';
            
            // X√≥a form
            document.getElementById('new_device_id').value = '';
            document.getElementById('new_device_name').value = '';

            // Quan tr·ªçng: G·ªçi l·∫°i h√†m loadDevices() ƒëang n·∫±m ngay trong file n√†y
            loadDevices(); 
        }
    }
</script>
</body>
</html> -->